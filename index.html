<html>
  <head>
    <title>Time Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #f5f5f7;
        color: #333;
        margin: 0;
        padding: 20px;
      }
      #time-tracker {
        max-width: 600px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1,
      h2 {
        color: #333;
      }
      .edit-btn,
      .save-btn,
      .delete-btn {
        margin-left: 10px;
        cursor: pointer;
        border: none;
        background-color: transparent;
      }
      .edit-btn:hover,
      .save-btn:hover,
      .delete-btn:hover {
        text-decoration: underline;
      }
      .edit-btn,
      .save-btn {
        color: #007bff;
      }
      .delete-btn {
        color: #ff0000; /* Red color for delete button */
      }
      input[type="text"] {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        width: calc(100% - 96px); /* Adjusted for smaller screens below */
        margin-right: 8px;
      }
      input:focus {
        outline: 2px solid #007bff;
        border-color: #007bff;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #0056b3;
      }
      #log div {
        border-bottom: 1px solid #eee;
        padding: 8px 0;
      }
    
      /* Responsive adjustments */
      @media (max-width: 768px) { /* Tablet and down */
        #time-tracker {
          padding: 15px;
        }
        input[type="text"], button {
          width: 100%; /* Make input and button full width */
          margin: 8px 0; /* Add some margin for vertical spacing */
        }
        .edit-btn, .save-btn, .delete-btn {
          margin: 5px 0; /* Adjust margin for smaller screens */
        }
      }
    
      @media (max-width: 480px) { /* Mobile */
        body {
          padding: 10px; /* Reduce padding */
        }
        h1, h2 {
          font-size: 1.5em; /* Adjust heading sizes for smaller screens */
        }
      }
    </style>
  </head>
  <body>
    <div id="time-tracker">
      <h1>Time Tracker</h1>
      <button onclick="exportLogsToCSV()">Export Logs to CSV</button>
      <div id="current-time"></div>
      <input type="text" id="text-input" placeholder="Enter task description" />
      <button onclick="addLap()">Add Lap</button>
      <h2>Log:</h2>
      <div id="log"></div>
    </div>

    <script>
      window.onload = function () {
        loadLogEntries();
        bindEnterKeyToAddLap();
        updateCurrentTime();
      };

      setInterval(updateCurrentTime, 1000); // Update current time every second

      function updateCurrentTime() {
        const currentTimeDisplay = document.getElementById("current-time");
        if (currentTimeDisplay) {
          currentTimeDisplay.textContent = new Date().toLocaleTimeString();
        }
      }

      function createButton(buttonType, text) {
        const btn = document.createElement("i");
        let iconClass = '';
        switch (buttonType) {
          case 'edit':
            iconClass = 'fas fa-edit';
            break;
          case 'delete':
            iconClass = 'fas fa-trash';
            break;
          default:
            console.error('Unknown button type:', buttonType);
            return;
        }
        btn.className = `${iconClass} ${buttonType}-btn`; // Add both the icon class and the buttonType-btn class
        btn.setAttribute("title", text); // Use title attribute for tooltip
        btn.setAttribute("data-action", buttonType);
        return btn;
      }

      function getFormattedDateTime() {
        return new Date().toLocaleString('en-US', {
          year: '2-digit',
          month: 'short',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        }).replace(',', ''); // Remove the comma after the date
      }

      function addLap() {
        const taskInput = document.getElementById("text-input");
        if (taskInput.value.trim() === "") return;
    
        const now = getFormattedDateTime(); // Use the new formatting function
        const task = taskInput.value;
        taskInput.value = "";
    
        const log = document.getElementById("log");
        const newEntry = document.createElement("div");
        const logEntry = { timestamp: now, task: task };
        newEntry.textContent = `${logEntry.timestamp} - ${logEntry.task}`;
    
        const editBtn = createButton("edit", "Edit");
        const deleteBtn = createButton("delete", "Delete");
    
        newEntry.appendChild(editBtn);
        newEntry.appendChild(deleteBtn);
        log.appendChild(newEntry);
    
        saveLogToLocalStorage();
      }
    

      function editEntry(entryDiv, logEntry) {
        const buttons = entryDiv.querySelectorAll(".edit-btn, .delete-btn");
        entryDiv.innerHTML = "";
        buttons.forEach((button) => entryDiv.appendChild(button));

        const input = document.createElement("input");
        input.type = "text";
        input.value = logEntry.task;
        input.classList.add("edit-input");

        const saveBtn = document.createElement("button");
        saveBtn.textContent = "Save";
        saveBtn.classList.add("save-btn");
        saveBtn.onclick = () =>
          saveEntry(entryDiv, input.value, logEntry.timestamp);

        // Bind Enter key to save action for the edit input field
        input.onkeyup = function (e) {
          if (e.keyCode === 13) {
            // Enter key
            saveEntry(entryDiv, input.value, logEntry.timestamp);
          }
        };

        entryDiv.insertBefore(input, buttons[0]);
        entryDiv.replaceChild(saveBtn, buttons[0]);
        input.focus();
      }

      function saveEntry(entryDiv, newTask, timestamp) {
        // Ensure timestamp includes both date and time if modifying it
        const logEntry = { timestamp: timestamp, task: newTask };
        entryDiv.innerHTML = `${logEntry.timestamp} - ${logEntry.task}`;
    
        const editBtn = createButton("edit", "Edit");
        const deleteBtn = createButton("delete", "Delete");
    
        entryDiv.appendChild(editBtn);
        entryDiv.appendChild(deleteBtn);
    
        saveLogToLocalStorage();
      }

      function deleteEntry(entryDiv) {
        entryDiv.remove();
        saveLogToLocalStorage();
      }

      function saveLogToLocalStorage() {
        const logEntries = [];
        document.querySelectorAll("#log > div").forEach((entryDiv) => {
          // Use extractLogEntry to get the log entry details
          const { timestamp, task } = extractLogEntry(entryDiv);
          logEntries.push({ timestamp, task });
        });
        localStorage.setItem("timeTrackerLog", JSON.stringify(logEntries));
      }

      function loadLogEntries() {
        const savedLog = JSON.parse(localStorage.getItem("timeTrackerLog"));
        if (savedLog) {
          const log = document.getElementById("log");
          log.innerHTML = "";
          savedLog.forEach((logEntry) => {
            const entryDiv = document.createElement("div");
            entryDiv.textContent = `${logEntry.timestamp} - ${logEntry.task}`;
    
            const editBtn = createButton("edit", "Edit");
            const deleteBtn = createButton("delete", "Delete");
    
            entryDiv.appendChild(editBtn);
            entryDiv.appendChild(deleteBtn);
            log.appendChild(entryDiv);
          });
        }
      }

      document.getElementById("log").addEventListener("click", function (event) {
        const target = event.target;
        const action = target.getAttribute("data-action");
        const entryDiv = target.closest("div");
        const logEntry = extractLogEntry(entryDiv);
        const actions = {
          edit: () => editEntry(entryDiv, logEntry),
          delete: () => {
            if (confirm("Are you sure you want to delete this entry?")) {
              deleteEntry(entryDiv);
            }
          }
        };
        const actionFunction = actions[action];
        if (actionFunction) {
          actionFunction();
        }
      });

      function extractLogEntry(entryDiv) {
        const textContent = entryDiv.childNodes[0].nodeValue.trim();
        const splitIndex = textContent.lastIndexOf(" - ");
        const timestamp = textContent.substring(0, splitIndex);
        const task = textContent.substring(splitIndex + 3);
        return { timestamp, task };
      }

      function bindEnterKeyToAddLap() {
        const taskInput = document.getElementById("text-input");
        taskInput.onkeyup = function (e) {
          if (e.keyCode === 13) {
            addLap();
          }
        };
      }

      function exportLogsToCSV() {
        const logEntries = JSON.parse(localStorage.getItem("timeTrackerLog"));
        if (!logEntries || logEntries.length === 0) {
          alert("No log entries to export.");
          return;
        }
      
        // UTF-8 Byte Order Mark (BOM)
        let csvContent = "\uFEFF"; // Add BOM to the start of the CSV
        csvContent += "Date,Time,Entry\n"; // CSV header
      
        logEntries.forEach(entry => {
          const dateTime = new Date(entry.timestamp);
          const date = dateTime.toLocaleDateString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
          const time = dateTime.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
          const task = entry.task.replace(/"/g, '""'); // Escape double quotes
          csvContent += `"${date}","${time}","${task}"\n`;
        });
      
        // Create a blob with the CSV content and trigger a download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "time_tracker_logs.csv");
        document.body.appendChild(link); // Required for Firefox
        link.click();
        document.body.removeChild(link);
      }
    </script>
  </body>
</html>